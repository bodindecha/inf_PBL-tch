const PBL=function(e){let a={API_URL:"/t/PBL/v2/api/",USER:top.USER,isModerator:top.USER_ADMIN,workFile:["แผนผังความคิดบูรณาการ 8 กลุ่มสาระการเรียนรู้","ใบงาน IS1-1 (ประเด็นที่ต้องการศึกษา)","ใบงาน IS1-2 (การระบุปัญหา)","ใบงาน IS1-3 (การระบุสมมติฐาน)","เล่มรายงานโครงงานบทที่ 1","เล่มรายงานโครงงานบทที่ 2","เล่มรายงานโครงงานบทที่ 3","เล่มรายงานโครงงานบทที่ 4","เล่มรายงานโครงงานบทที่ 5","รวมเล่มรายงานโครงงาน (ฉบับเต็ม)","บทคัดย่อโครงงาน","โปสเตอร์"],fileList:{mindmap:"แผนผังความคิด","IS1-1":"ใบงาน IS1-1","IS1-2":"ใบงาน IS1-2","IS1-3":"ใบงาน IS1-3","report-1":"เล่มรายงานบทที่ 1 ","report-2":"เล่มรายงานบทที่ 2 ","report-3":"เล่มรายงานบทที่ 3 ","report-4":"เล่มรายงานบทที่ 4 ","report-5":"เล่มรายงานบทที่ 5 ","report-all":"เล่มรายงานฉบับเต็ม",abstract:"บทคัดย่อ",poster:"โปสเตอร์"}};var t={started:!1,opts:null,state:{useFilter:!1,loaded:!1}},o=async function(){if(location.hash.length>1){var e={};location.hash.substring(1,location.hash.length).split("&").forEach(a=>{let t=a.split("=");e[t[0]]=t[1]}),void 0!==e.filter&&r(objDecrypt(e.filter)),void 0!==e.autoload&&(PBL.load(),app.io.URL.removeHash("autoload="))}},r=function(t){var o={},r=["type","isAdvisor","search_type","search_diff","search_key","sort","order"];if(t.split("&").forEach(e=>{let a=e.split("="),t=null;switch(a[0]){case"grade":t="main .mform [name=grade]";break;case"room":t="main .mform [name=room]";break;case"type":t="main .fform [name=type]";break;case"isAdvisor":t="main .fform [name=advisor]";break;case"search_type":t="main .fform [name=search_type]";break;case"search_diff":t="main .fform [name=search_range]";break;case"search_key":t="main .fform [name=search_key]",a[1]=decodeURIComponent(a[1]);break;case"wf_status":t="main .fform [name=status]";break;case"wf_count":t="main .fform [name=work]";break;case"mbr_comp":t="main .fform [name=mbr_comp]",a[1]=decodeURIComponent(a[1]);break;case"mbr_amt":t="main .fform [name=mbr_amt]";break;case"sort":t="main .fform [name=sort]";break;case"order":t="main .fform [name=order]",a[1]=a[1].toLowerCase()}null!=t&&$(t).val(a[1]),o[a[0]]=a[1]}),Object.keys(o).includes("wf_file")&&void 0!==o.wf_count){o.wf_file=parseInt(decodeURIComponent(o.wf_file));for(let n=0;n<a.workFile.length;n++)o.wf_file&Math.pow(2,n)&&(e.querySelector('main .fform [name=files] option[value="'+n+'"]').selected=!0)}Object.keys(o).filter(e=>r.includes(e)).length&&pUI.filter.show(),i()},n=function(){var e={grade:parseInt($("main .mform [name=grade]").val()),room:parseInt($("main .mform [name=room]").val())};if(0==e.grade&&delete e.grade,0==e.room&&delete e.room,void 0!==e.grade&&(e.grade<1||e.grade>6))app.ui.notify(1,[2,"Invalid grade."]),$("main .mform [name=grade]").focus();else if(void 0!==e.room&&(e.room<1||e.room>19))app.ui.notify(1,[2,"Invalid room."]),$("main .mform [name=room]").focus();else if(!t.state.useFilter)return t.opts=e,e;else if(" "==(e={...e,type:$("main .fform [name=type]").val(),isAdvisor:$("main .fform [name=advisor]").val(),search_type:$("main .fform [name=search_type]").val(),search_diff:$("main .fform [name=search_range]").val(),search_key:$("main .fform [name=search_key]").val().trim().replaceAll("เเ","แ"),wf_file:$("main .fform [name=files]").val(),wf_status:$("main .fform [name=status]").val(),wf_count:$("main .fform [name=work]").val(),mbr_comp:$("main .fform [name=mbr_comp]").val(),mbr_amt:parseInt($("main .fform [name=mbr_amt]").val()),sort:$("main .fform [name=sort]").val(),order:$("main .fform [name=order]").val().toUpperCase()}).type&&delete e.type,"A"==e.isAdvisor&&delete e.isAdvisor,">="==e.mbr_comp&&1==e.mbr_amt&&(delete e.mbr_comp,delete e.mbr_amt),"class"==e.sort&&"ASC"==e.order&&(delete e.sort,delete e.order),[void 0,..."ABCDEFGHIJKLM-".split(""),""].includes(e.type)){if([void 0,"Y","N"].includes(e.isAdvisor)){if(e.search_key.length&&!["code","name","member","advisor"].includes(e.search_type))app.ui.notify(1,[2,"Invalid search type."]),$("main .fform [name=search_type]").focus();else if(e.search_key.length&&!"SEC".split("").includes(e.search_diff))app.ui.notify(1,[2,"Invalid search type."]),$("main .fform [name=search_type]").focus();else if(e.search_key.length&&!e.search_key.match($("main .fform [name=search_type] option:checked").attr("data-regex")))app.ui.notify(1,[2,"Invalid search keyword."]),$("main .fform [name=search_key]").focus();else if(e.wf_file.length&&!["sent","none"].includes(e.wf_status))app.ui.notify(1,[2,"Invalid work status."]),$("main .fform [name=status]").focus();else if(e.wf_file.length&&!["all","some"].includes(e.wf_count))app.ui.notify(1,[2,"Invalid work counting method."]),$("main .fform [name=work]").focus();else if([void 0,">=",">","<=","<","=","!="].includes(e.mbr_comp)){if("number"===e.mbr_amt&&(e.mbr_amt<1||e.mbr_amt>7))app.ui.notify(1,[2,"Invalid member amount selected."]),$("main .fform [name=mbr_amt]").focus();else if([void 0,"class","code","name","time"].includes(e.sort)){if([void 0,"ASC","DESC"].includes(e.order))return e.search_key.length?"code"==e.search_type&&(e.search_key=e.search_key.toUpperCase()):(delete e.search_type,delete e.search_diff,delete e.search_key),e.wf_file.length?e.wf_file=e.wf_file.reduce((e,a)=>e+Math.pow(2,parseInt(a)),0):(delete e.wf_file,delete e.wf_status,delete e.wf_count),t.opts=e,e;app.ui.notify(1,[2,"Invalid ordering type."]),$("main .fform [name=order]").focus()}else app.ui.notify(1,[2,"Invalid ordering index."]),$("main .fform [name=sort]").focus()}else app.ui.notify(1,[2,"Invalid member amount comparer."]),$("main .fform [name=mbr_comp]").focus()}else app.ui.notify(1,[2,"Invalid advisor selection."]),$("main .fform [name=advisor]").focus()}else app.ui.notify(1,[2,"Invalid project type."]),$("main .fform [name=type]").focus();return null},i=async function(e=0){e?$("main .browser div:last-child > button").attr("disabled",""):(n(),$('main .mform button[onClick*="PBL.load"]').attr("disabled","")),await ajax(a.API_URL+"list",{type:"group",act:null,param:{...t.opts,loadNext:e}}).then(function(a){if(e)$("main .browser div:last-child > button").removeAttr("disabled");else{let o=location.pathname+location.search+location.hash;history.replaceState(null,null,location.pathname+location.search+(Object.keys(t.opts).length?"#filter="+objEncrypt(t.opts):"")),o!=location.pathname+location.search+location.hash&&sys.back.logPageHistory()}a?s(a.projects,a.nextLoad,!e):e||pUI.filter.enableSearch()})},s=async function(a,o,r=!1){var n=$("main .browser .results"),i=$("main .browser > div:last-child > *");t.state.loaded||(t.state.loaded=!0,$('<hr style="display: none;">').insertAfter("main .fform").fadeIn(),$("main .oform").toggle("blind"),n.parent().show()),r&&n.html(""),a.length?(a.forEach(e=>{n.append(l(e))}),null!=o?i.replaceWith(`<button class="blue hollow small" onClick="PBL.load(${o})">Load more</button>`):i.fadeOut(function(){$(this).replaceWith("<span>——— End of results ———</span>").show()}),r?e.querySelector("main .oform").reset():pUI.filter.update()):r?i.replaceWith('<div class="message gray">No result</div>'):i.fadeOut(function(){$(this).replaceWith("<span>——— End of results ———</span>").show()})},l=e=>`<li><div class="accordian" onClick="PBL.expand(this)"><div class="title"><span class="title-name txtoe">${e.title==e.code?"":e.title}</span><span class="title-code">${e.code}</span></div></div><div class="extender" data-code="${e.code}" data-loaded="false" style="height: 0;"><div class="details"><p>สมาชิก <output name="${e.code}:class"></output></p><table class="namelist slider"><tbody name="${e.code}:member"></tbody></table><p hidden>สาขาโครงงาน: <output name="${e.code}:type"></output></p><ul hidden name="${e.code}:advisor"></ul><p>แก้ไขล่าสุด<output name="${e.code}:update"></output></p><p hidden>ได้ <output name="${e.code}:score"></output> คะแนน</p></div><div class="action form inline"><!-- <div class="group" hidden><span class="small">Submissions</span><select name="${e.code}:file"></select><button onClick="pUI.viewFile('${e.code}')" class="cyan small hollow">View</button></div> --><!div class="group"><a role="button" href="/t/PBL/v2/group/${e.code}/browse" class="purple small hollow" target="_blank" draggable="false">View submissions</a>${a.isModerator?`<a role="button" href="/t/PBL/v2/group/${e.code}/edit" class="orange small hollow" target="_blank" draggable="false">Overwrite</a>`:""}<!/div></div></div></li>`;return{init:function(){if(!t.started){$("main .mform [name=grade]").append('<option value="0">ทุกระดับชั้น</option>'),$("main .mform [name=room]").append('<option value="0">ทุกห้องเรียน</option>');for(let e=1;e<=6;e++)$("main .mform [name=grade]").append(`<option value="${e}">ม.${e}</option>`);for(let r=1;r<=19;r++)$("main .mform [name=room]").append(`<option value="${r}">${r}</option>`);for(let n=0;n<a.workFile.length;n++)$("main .fform [name=files]").append(`<option value="${n}">${a.workFile[n]}</option>`);for(let i=1;i<=7;i++)$("main .fform [name=mbr_amt]").append(`<option value="${i}">${i}</option>`);$("main .mform, main .fform").on("change",pUI.filter.enableSearch),o(),$(window).on("resize",function(){setTimeout(function(){var e=$("main .results > li[open] .extender");e.css("height",(e.children().first().outerHeight()+e.children().last().outerHeight()).toString()+"px")},250)}),t.started=!0}},load:i,expand:async function(e){var t=$(e).next();e=$(e.parentNode);let o=t.attr("data-code");e.is("[open]")?(e.removeAttr("open"),e.children().last().animate({height:0},500)):"false"==t.attr("data-loaded")?await ajax(a.API_URL+"information",{type:"group",act:o}).then(async function(r){if(/*$("main .results > li[open] .extender").animate({height:0},500).parent().removeAttr("open"),*/r){$('main .results output[name="'+o+':class"]').val(r.class),r.type.length&&$('main .results output[name="'+o+':type"]').val(r.type).parent().removeAttr("hidden"),null!=r.score&&$('main .results output[name="'+o+':score"]').val(r.score).parent().removeAttr("hidden"),$('main .results output[name="'+o+':update"]').val(r.update),await ajax(a.API_URL+"information",{type:"person",act:"student",param:r.member.join(",")}).then(function(e){var a=1,t="";e.list.forEach(e=>{t+="<tr><td>"+a.toString()+".</td><td>"+e.fullname+' (<a href="/user/'+e.ID+'" target="_blank" draggable="false">'+e.nickname+"</a>)</td><td>เลขที่ "+e.number+"</td><td>",1==a++&&(t+='<a role="button" class="blue hollow pill" disabled>หัวหน้ากลุ่ม</a>'),t+="</td></tr>"}),$('main .results tbody[name="'+o+':member"]').html(t)}),r.advisor.length&&await ajax(a.API_URL+"information",{type:"person",act:"teacher",param:r.advisor.join(",")}).then(function(e){var a=$('main .results ul[name="'+o+':advisor"]').removeAttr("hidden");r.advisor.forEach(t=>{void 0!==e.list[t]&&a.append("<li>"+e.list[t]+"</li>")}),$("<p>ครูที่ปรึกษาโครงงาน</p>").insertBefore(a)});var n=$('main .results .action [name="'+o+':file"]'),i=["2","4"].includes(r.class.substring(2,3));Object.keys(a.fileList).forEach(e=>{(i&&/^IS\d-\d$/.test(e)||!/^IS\d-\d$/.test(e))&&n.append('<option value="'+e+'">'+a.fileList[e]+"</option>")}),t.attr("data-loaded","true"),e.attr("open",""),t.animate({height:t.children().first().outerHeight()+t.children().last().outerHeight()},500,$.bez([.65,0,.35,1]))}}):($("main .results > li[open] .extender").animate({height:0},500).parent().removeAttr("open"),e.attr("open",""),t.animate({height:t.children().first().outerHeight()+t.children().last().outerHeight()},500,$.bez([.65,0,.35,1])))},changeState(e,a){t.state[e]=a},cv:a}}(document);