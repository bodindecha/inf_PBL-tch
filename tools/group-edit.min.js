const PBL=function(e){let t={API_URL:"/t/PBL/v2/api/",USER:top.USER,HTML:{"tab-menu":(e,t,a)=>'<div class="tab" data-page="'+e+'" onClick="PBL.openPage(this)"><div class="face"><i class="material-icons">'+a+"</i><span>"+t+'</span></div><div class="pop-label"><span>'+t+"</span></div></div>",timeline(e,t){if(!t.sem)return'</div><br><p>ภาคเรียนที่ 2</p><div class="progress slider">';e=e.toString();var a='<div class="sec sec-'+t.deadline+'"><div class="disp" data-title="'+t.title+'"><span class="line"></span><label>'+e+'</label></div><p>กำหนดส่งภายใน</p><output deadline="'+t.deadline+'"></output><div class="asgmt-list">';return Object.keys(t.works).forEach(e=>{a+='<div class="work"><i class="material-icons" work="'+e+'"></i><label>'+t.works[e]+"</label></div>"}),a+="</div></div>"},"work-act":e=>'<button class="blue" onClick="PBL.upload(\''+e+'\')" data-title="Replace with new file"><i class="fa fa-upload"></i></button><button class="gray" onClick="PBL.file.preview(\''+e+'\')" data-title="View file"><i class="material-icons">visibility</i></button><button class="yellow" onClick="PBL.file.print(\''+e+'\')" data-title="Print file"><i class="material-icons">print</i></button><button class="green" onClick="PBL.file.download(\''+e+'\')" data-title="Download file"><i class="material-icons">download</i></button><button class="red" onClick="PBL.file.remove(\''+e+'\')" data-title="Remove file"><i class="material-icons">delete</i></button>'},tab_menu:{ng:[["create","Create","library_add"],["open","Open","exit_to_app"]],hg:[["information","Information","library_books"],["member","Members","group"],["submissions","Submissions","assignment"],["comments","Comments","comment"]]},timeline:[{isPBL:!0,title:"การจัดกลุ่ม",deadline:"A",works:{n1:"ชื่อโครงงาน",n2:"ครูที่ปรึกษา",n3:"สาขาโครงงาน"},sem:1},{isPBL:!0,title:"ส่งผังความคิด",deadline:"B",works:{mindmap:"ผังความคิดบูรณาการ 8 กลุ่มสาระการเรียนรู้"},sem:1},{isPBL:!1,title:"ส่งใบงาน IS",deadline:"C",works:{"IS1-1":"IS1-1 ประเด็นที่สนใจ","IS1-2":"IS1-2 ปัญหาเกี่ยวกับประเด็นที่สนใจ","IS1-3":"IS1-3 สมมติฐานที่เกี่ยวข้อง"},sem:1},{isPBL:!0,title:"ส่งบทที่ 1-3",deadline:"D",works:{"report-1":"รายงานโครงงานบทที่ 1","report-2":"รายงานโครงงานบทที่ 2","report-3":"รายงานโครงงานบทที่ 3"},sem:1},{sem:0},{isPBL:!0,title:"ส่งบทที่ 4-5",deadline:"E",works:{"report-4":"รายงานโครงงานบทที่ 4","report-5":"รายงานโครงงานบทที่ 5"},sem:2},{isPBL:!0,title:"ส่งเล่มเต็มและอื่นๆ",deadline:"F",works:{"report-all":"รวมเล่มรายงานโครงงาน",abstract:"บทคัดย่อโครงงาน"},sem:2},{isPBL:!0,title:"ส่งโปสเตอร์",deadline:"G",works:{poster:"โปสเตอร์"},sem:2},],MSG:{"delete-group":"Are you sure you want to delete this group and its progress (all your work) ?\nThis action can't be undone.","delete-mbr":"Are you sure you want to delete this member?\nThis action can't be undone.",newLeader:"Are you sure you want to set your friend as the new group leader?\nThis action can't be undone.","del-work":e=>'Are you sure you want to delete group "'+e+"\" file?\nThis action can't be undone."},workload:{mindmap:"แผนผังความคิดบูรณาการ 8 กลุ่มสาระการเรียนรู้","IS1-1":"ใบงาน IS1-1 (ประเด็นที่ต้องการศึกษา)","IS1-2":"ใบงาน IS1-2 (การระบุปัญหา)","IS1-3":"ใบงาน IS1-3 (การระบุสมมติฐาน)","report-1":"เล่มรายงานโครงงานบทที่ 1","report-2":"เล่มรายงานโครงงานบทที่ 2","report-3":"เล่มรายงานโครงงานบทที่ 3","report-4":"เล่มรายงานโครงงานบทที่ 4","report-5":"เล่มรายงานโครงงานบทที่ 5","report-all":"รวมเล่มรายงานโครงงาน (ฉบับเต็ม)",abstract:"บทคัดย่อโครงงาน",poster:"โปสเตอร์"},mbr_settings:["statusOpen","publishWork","maxMember"]};var a={started:!1,HTML:{},current:{page:"",workType:""},state:{button_freeze:!1,loadInfoOver:!0,loadSettingsOver:!0},notifyJsInited:!1,history:{unsavedPage:[]}},n={freeze:function(){$("main .pages .page.current button, main .tab-selector").attr("disabled",""),a.state.button_freeze=!0},unfreeze:function(){a.state.button_freeze&&($("main .pages .page.current button, main .tab-selector").removeAttr("disabled"),a.state.button_freeze=!1,"information"===a.current.page&&(a.state.loadInfoOver=!1,f(a.current.page)))}},i=function(){a.notifyJsInited||(a.notifyJsInited=!0,$.notify.addStyle("PBL-unsaved",{html:'<div><div class="clearfix"><div class="title" data-notify-html="title"></div><div class="form inline"><button class="yellow" name="keep">Keep unsaved changes</button><button class="red hollow" name="load">Load updates</button></div></div></div>'}),$(document).on("click",'main .notifyjs-PBL-unsaved-base [name="keep"]',function(){$(this).trigger("notify-hide")}),$(document).on("click",'main .notifyjs-PBL-unsaved-base [name="load"]',function(){u(),$(this).trigger("notify-hide")}),$(document).on("click",'main .page[path="member"] .notifyjs-PBL-unsaved-base [name="load"]',function(){$('main .page[path] .settings [onClick^="PBL.save.settings"]').attr("disabled",""),t.mbr_settings.slice(0,2).forEach(t=>{e.querySelector('main .page[path] .settings [name="'+t+'"]').checked="Y"==a.groupSettings[t]}),t.mbr_settings.slice(2,3).forEach(e=>{$('main .page[path] .settings [name="'+e+'"]').val(a.groupSettings[e])}),a.state.loadSettingsOver=!0,h("member"),$(this).trigger("notify-hide")}))},o=async function(){var e=location.pathname.match(/\/[A-Z0-9]{6}\//);if(null!=e&&e.length)await ajax(t.API_URL+"group-status",{type:"get",act:"personal",param:e=e[0].slice(1,7)}).then(function(e){let t=r(e.isGrouped,"render");a.status=e,a.code=e.code,s(t)});else{let n=r(!1,"render");a.status={isGrouped:!1},a.code=null,s(n)}},r=function(e=null,t=null){var a=location.hash.substring(1),n=[null];return a.length&&(!1==e?"create"==a?n=[a]:"open"==a&&(n=[a,null]):!0==e&&/^(information|member|submissions|comments)$/.test(a)&&(n=[a])),n},s=function(e){null==e[1]&&e[2]>=0&&(a.status={isGrouped:!1},a.code=null);var n=a.status.isGrouped?"h":"n";$("main > .container").html(a.HTML["header-bar"]).append('<div class="wrapper tab-selector"><div class="tabs"></div></div>').append('<section class="pages"></section>');var i=$("main > .container .tab-selector .tabs").css("--tab-count",t.tab_menu[n+"g"].length);t.tab_menu[n+"g"].forEach(e=>i.append(t.HTML["tab-menu"](...e))),null==e[0]&&(e[0]=a.status.isGrouped?"member":"open"),$("main > .container .pages").load("/t/PBL/v2/tools/group-edit_blocks.html .pages[page-type="+n+"g]",function(){$("main > .container > .pages").html($("main > .container .pages > .pages").html()),PBL.openPage(e[0],e),"h"==n&&(l("member","settingsOption"),l("submissions","readyTable"),chatApp.start("tch",[a.code]),a.chatInit=!1)})},l=function(e,...n){switch(e){case"create":break;case"open":null==n[0]||"open"==n[0]?$('main .page[path="open"] [name="gjc"]').focus():n[0].length&&($('main .page[path="open"] [name="gjc"]').val(n[0]),$('main .page[path="open"] button').focus());break;case"information":a.state.loadInfoOver?u():$('main .page[path="information"] .form').notify({title:"You have unsaved changes."},{className:"warning",elementPosition:"bottom right",autoHideDelay:6e4,clickToHide:!1,style:"PBL-unsaved"}),a.state.button_freeze=!0;break;case"member":if("settingsOption"==n[0]){var i=[$('main .page[path] .settings [name="maxMember"]')];for(let o=1;o<=7;o++)i[0].append('<option value="'+o+'">'+o+"</option>")}else $('main .page[path="member"] .code output[name="gjc"]').val(a.code),d();break;case"submissions":if("readyTable"==n[0]){var r="";Object.keys(t.workload).forEach(e=>{(a.status.requireIS||"IS"!=e.substr(0,2))&&(r+='<tr><td><span class="--txtoe">'+t.workload[e]+'</span></td><td><div class="group center" data-work="'+e+'">',r+='</div></td><td center><output name="'+e+'"></output></td></tr>')}),$('main .page[path="submissions"] .work tbody').html(r)}else p();break;case"comments":a.chatInit||(a.chatInit=!0,chatApp.init(!0))}},c=function(e){void 0!==e.message&&e.message.forEach(e=>app.ui.notify(1,e)),e.isGrouped&&(a.status=e,a.code=e.code,s([null]))},p=async function(){await ajax(t.API_URL+"group-status",{type:"work",act:"file",param:{code:a.code}}).then(function(e){e?Object.keys(e).forEach(a=>{if(!/^n\d+$/.test(a)){$('main .page[path="submissions"] .work output[name="'+a+'"]').attr("class",e[a]?"y":"n").val(e[a]?"ส่งแล้ว":"ไม่มีไฟล์");var n=e[a]?t.HTML["work-act"](a):'<button class="blue hollow" onClick="PBL.upload(\''+a+'\')"><i class="material-icons">add_circle</i>Upload attatchment</button>';$('main .page[path="submissions"] .work [data-work="'+a+'"]').html(n).attr("class","group center"+(e[a]?" action":""))}}):sys.auth.orize(!0,!0),a.workStatus=e})},u=async function(){await ajax(t.API_URL+"group-information",{type:"group",act:"title",param:{code:a.code}}).then(async function(e){if(void 0===e.isGrouped||e.isGrouped){e.score?($('main .page[path="information"] .score').fadeIn(),$('main .page[path="information"] [name="net"]').text(e.score).attr("class","color-"+" rrrog".split("")[e.score])):($('main .page[path="information"] .score').fadeOut(),$('main .page[path="information"] [name="net"]').text("").removeAttr("class")),delete e.score,Object.keys(e).forEach(t=>$('main .page[path="information"] [name="'+t+'"]').val(e[t]||"")),a.state.loadInfoOver=!0,h(a.current.page);var n=[e.adv1,e.adv2,e.adv3].filter(e=>null!=e);if(n.length)await ajax(t.API_URL+"information",{type:"person",act:"teacher",param:n.join(",")}).then(function(e){Object.keys(e.list).forEach(t=>$('main .page[path="information"] [name="adv'+(n.indexOf(t)+1).toString()+'"] + input').val(e.list[t]));for(let t=Object.keys(e.list).length+1;t<=3;t++)$('main .page[path="information"] [name="adv'+t.toString()+'"] + input').val("")});else for(let i=1;i<=3;i++)$('main .page[path="information"] [name="adv'+i.toString()+'"] + input').val("")}else s([null,null,0]);return e}).then(function(e){e&&$("main .pages .page.current button").attr("disabled","")})},d=async function(n=!0){await ajax(t.API_URL+"group-information",{type:"group",act:"member",param:{code:a.code}}).then(async function(i){void 0===i.isGrouped||i.isGrouped?(await ajax(t.API_URL+"information",{type:"person",act:"student",param:i.list.join(",")}).then(function(e){var t=1,n="";a.isLeader=e.list[0].ID,e.list.forEach(e=>{n+="<tr><td>"+t.toString()+".</td><td>"+e.fullname+' (<a href="/'+e.ID+'" target="_blank" draggable="false">'+e.nickname+"</a>)</td><td>เลขที่ "+e.number+"</td><td>",1==t++?n+='<a role="button" class="default" disabled>หัวหน้ากลุ่ม</a>':n+='<div class="group"><button onClick="PBL.kick('+e.ID+')" class="red hollow">ลบชื่อออก</button><button onClick="PBL.setLeader('+e.ID+')" class="yellow hollow icon" data-title="Set as leader">\uD83D\uDC51</button></div>',n+="</td></tr>"}),$('main .page[path="member"] .list tbody').html(n)}),a.groupSettings=i.settings,n&&(a.state.loadSettingsOver?($('main .page[path] .settings [onClick^="PBL.save.settings"]').attr("disabled",""),t.mbr_settings.slice(0,2).forEach(t=>{e.querySelector('main .page[path] .settings [name="'+t+'"]').checked="Y"==a.groupSettings[t]}),t.mbr_settings.slice(2,3).forEach(e=>{$('main .page[path] .settings [name="'+e+'"]').val(a.groupSettings[e])}),a.state.loadSettingsOver=!0,h(a.current.page)):$("main .page[path] .settings").notify({title:"You have unsaved changes."},{className:"warning",elementPosition:"bottom center",autoHideDelay:6e4,clickToHide:!1,style:"PBL-unsaved"}))):s([null,null,0])})},m=async function(e,n=null){e||n==a.isLeader?confirm(t.MSG["delete-group"])&&await ajax(t.API_URL+"group-action",{type:"delete",act:"void",param:{code:a.code}}).then(function(e){void 0!==e.message&&e.message.forEach(e=>app.ui.notify(1,e)),e&&(history.replaceState(null,null,"/t/PBL/v2/group/home"),s([null,null,1]))}):confirm(t.MSG["delete-mbr"])&&await ajax(t.API_URL+"group-action",{type:"delete",act:"member",param:{code:a.code,mbr:n}}).then(function(e){e&&(void 0!==e.message&&e.message.forEach(e=>app.ui.notify(1,e)),d(!1))})},g=function(e){m(!1,e)},f=function(e){a.history.unsavedPage.length||$(window).bind("beforeunload",function(){return a.history.unsavedPage.includes(a.current.page)||PBL.openPage(a.history.unsavedPage[a.history.unsavedPage.length-1]),null}),a.history.unsavedPage.includes(e)||a.history.unsavedPage.push(e)},h=function(e){let t=a.history.unsavedPage.indexOf(e);t>-1&&a.history.unsavedPage.splice(t,1),a.history.unsavedPage.length||app.io.confirm("unleave")};return{init:function(){if(!a.started){if(a.started=!0,!t.USER.length)return sys.auth.orize(!0,!0);a.HTML["header-bar"]=$("main > .container").html(),o(),i()}},openPage:function(t,n=[]){"string"==typeof t&&(t=e.querySelector('main .tab-selector .tab[data-page="'+t+'"]'));var i=$(t).attr("data-page");if(i==a.current.page)return!1;n.length,history.replaceState(null,null,location.pathname+location.search+"#"+i),a.current.page=i,$("main .tab-selector .tab.active").removeClass("active"),$(t).addClass("active"),$("main .pages .page.current").removeClass("current"),$('main .pages .page[path="'+i+'"]').addClass("current"),n.length>1&&n.shift(),l(i,...n)},help:function(t=null){if(null==t)app.ui.lightbox.open("mid",{title:"ความช่วยเหลือ",allowclose:!0,autoclose:6e4,html:e.querySelector("main > .manual[hidden]").innerHTML});else{switch(t){case"document":app.ui.notify(1,[2,"Help: Manual document is currently unavailable."]);break;case"mediaVDO":app.ui.notify(1,[2,"Help: Manual video playlist is currently unavailable."]);break;default:window.open($("main > .manual[hidden] a[onClick$=\"PBL.help('"+t+"')\"]").attr("data-href"))}app.ui.lightbox.close()}},createGroup:function(e){return!async function(e){if(e){var a={nameth:$('main .page[path="create"] [name="nameth"]').val().trim().replaceAll("เเ","แ"),nameen:$('main .page[path="create"] [name="nameen"]').val().trim().replaceAll("เเ","แ"),mbr1:$('main .page[path="create"] [name="mbr1"]').val(),adv1:$('main .page[path="create"] [name="adv1"]').val(),adv2:$('main .page[path="create"] [name="adv2"]').val(),adv3:$('main .page[path="create"] [name="adv3"]').val(),type:$('main .page[path="create"] [name="type"]').val()};a.nameth.length&&!/^[ก-๛0-9A-Za-z ()[\]{}\-!@#$%.,/&*+_?|]{3,150}$/.test(a.nameth)?(app.ui.notify(1,[2,"Invalid Thai project name."]),$('main .page[path="create"] [name="nameth"]').focus()):a.nameen.length&&!/^[A-Za-z0-9ก-๛ ()[\]{}\-!@#$%.,/&*+_?|]{3,150}$/.test(a.nameen)?(app.ui.notify(1,[2,"Invalid English project name."]),$('main .page[path="create"] [name="nameen"]').focus()):" ABCDEFGHIJKLM".includes(a.type)?(n.freeze(),await ajax(t.API_URL+"group-action",{type:"create",act:"new-group",param:a}).then(c).then(n.unfreeze)):(app.ui.notify(1,[2,"Invalid project type."]),$('main .page[path="create"] [name="type"]').focus())}else $('main .page[path="create"] input, main .page[path="create"] select').val("")}(e),!1},openGroup:function(){var e;return(e=$('main .page[path="open"] [name="gjc"]').val().trim().toUpperCase()).length?/^[A-Z0-9]{6}$/.test(e)?(n.freeze(),history.replaceState(null,null,"/t/PBL/v2/group/"+e+"/edit"),o()):(app.ui.notify(1,[2,"Invalid group code."]),$('main .page[path="open"] [name="gjc"]').focus()):(app.ui.notify(1,[2,"Group code empty."]),$('main .page[path="open"] [name="gjc"]').focus()),!1},terminate:m,kick:g,setLeader:async function(e){e==a.isLeader?app.ui.notify(1,[1,"You are already a group leader."]):confirm(t.MSG.newLeader)&&await ajax(t.API_URL+"group-action",{type:"update",act:"leader",param:{code:a.code,mbr:e}}).then(function(e){e&&(void 0!==e.message&&e.message.forEach(e=>app.ui.notify(1,e)),d(!0))})},upload:function(e){if(!1==e){PBL.save.file(!1);return}a.current.workType=e,app.ui.lightbox.open("mid",{allowclose:!0,html:'<iframe src="/t/PBL/v2/group/'+a.code+'/upload" style="width:90vw;height:712px;border:none">Loading...</iframe>'})},save:{info:function(){return!async function(){var e={code:a.code,nameth:$('main .page[path="information"] [name="nameth"]').val().trim().replaceAll("เเ","แ"),nameen:$('main .page[path="information"] [name="nameen"]').val().trim().replaceAll("เเ","แ"),adv1:$('main .page[path="information"] [name="adv1"]').val(),adv2:$('main .page[path="information"] [name="adv2"]').val(),adv3:$('main .page[path="information"] [name="adv3"]').val(),type:$('main .page[path="information"] [name="type"]').val()};e.nameth.length&&!/^[ก-๛0-9A-Za-z ()[\]{}\-!@#$%.,/&*+_?|]{3,150}$/.test(e.nameth)?(app.ui.notify(1,[2,"Invalid Thai project name."]),$('main .page[path="information"] [name="nameth"]').focus()):e.nameen.length&&!/^[A-Za-z0-9ก-๛ ()[\]{}\-!@#$%.,/&*+_?|]{3,150}$/.test(e.nameen)?(app.ui.notify(1,[2,"Invalid English project name."]),$('main .page[path="information"] [name="nameen"]').focus()):" ABCDEFGHIJKLM".includes(e.type)?(n.freeze(),await ajax(t.API_URL+"group-action",{type:"update",act:"information",param:e}).then(function(e){void 0===e.isGrouped||e.isGrouped?void 0!==e.message&&e.message.forEach(e=>app.ui.notify(1,e)):s([null,null,0])}).then(n.unfreeze).then(function(){$("main .pages .page.current button").attr("disabled",""),a.state.loadInfoOver=!0,h(a.current.page)})):(app.ui.notify(1,[2,"Invalid project type."]),$('main .page[path="information"] [name="type"]').focus())}(),!1},settings:async function(n){if(void 0===a.groupSettings[n])app.ui.notify(1,[3,"Setting not found."]);else{var i,o=(i=n,t.mbr_settings.slice(0,2).includes(i)?e.querySelector('main .page[path] .settings [name="'+i+'"]').checked?"Y":"N":t.mbr_settings.slice(2,3).includes(i)?$('main .page[path] .settings [name="'+i+'"]').val():[null]),r=$("main .page[path] .settings [onClick=\"PBL.save.settings('"+n+"')\"]");o==[null]&&app.ui.notify(1,[3,"Error validating your setting."]),a.groupSettings[n]==o?(app.ui.notify(1,[1,"No change applies."]),r.attr("disabled","")):await ajax(t.API_URL+"group-information",{type:"settings",act:"member",param:[n,o,a.code]}).then(function(e){void 0!==e.message&&e.message.forEach(e=>app.ui.notify(1,e)),e&&(a.groupSettings[n]=o,r.attr("disabled",""))})}},file:function(e){app.ui.lightbox.close(),"complete"==e&&p(),a.current.workType=""}},file:{preview:function(e){app.ui.lightbox.open("mid",{title:"ไฟล์"+t.workload[e],allowclose:!0,html:'<iframe src="preview?file='+e+"&code="+a.code+'" style="width:90vw;height:80vh;border:none">Loading...</iframe>'})},print:async function(e){var n=$('main .page[path="submissions"] .work [data-work="'+e+'"] button[onClick*="print"]');await ajax(t.API_URL+"group-status",{type:"get",act:"fileLink",param:{code:a.code,type:e}}).then(function(e){void 0===e.isGrouped||e.isGrouped?(e.print?(e.print=atob(e.print),/.+\.pdf$/.test(e.print)?printJS(e.print):printJS(e.print,"image")):app.ui.notify(1,[3,"There's a problem preparing your file for print."]),setTimeout(function(){n.removeAttr("disabled")},500)):s([null,null,0])}),n.attr("disabled","")},download:async function(n){var i=$('main .page[path="submissions"] .work [data-work="'+n+'"] button[onClick*="download"]');await ajax(t.API_URL+"group-status",{type:"get",act:"fileLink",param:{code:a.code,type:n}}).then(function(t){void 0===t.isGrouped||t.isGrouped?t.download?(e.querySelector('main iframe[name="dlframe"]').src=t.download,setTimeout(function(){i.removeAttr("disabled")},5e3)):(i.removeAttr("disabled"),app.ui.notify(1,[3,"There's a problem downloading your file."])):s([null,null,0])}),i.attr("disabled","")},remove:async function(e){if(confirm(t.MSG["del-work"](t.workload[e]))){var n=$('main .page[path="submissions"] .work [data-work="'+e+'"] button[onClick*="remove"]');await ajax(t.API_URL+"group-main",{type:"work",act:"remove",param:{code:a.code,type:e}}).then(function(e){void 0===e.isGrouped||e.isGrouped?e||n.removeAttr("disabled"):s([null,null,0]),p()}),n.attr("disabled","")}}},btnAction:n,groupCode:()=>a.code,pageURL:()=>a.current.page,uploadType:()=>a.current.workType,setState:(e,t)=>a.state[e]=t,confirmLeave:f}}(document);top.PBL=PBL;